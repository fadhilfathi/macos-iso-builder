name: Publish Release v1.0.0

on:
  workflow_run:
    workflows:
      - "Build macOS Installer ISO/DMG image"
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set GH_TOKEN
        run: echo "GH_TOKEN is set"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download latest build artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./release-artifact

          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            echo "Downloading artifact from workflow_run ID ${{ github.event.workflow_run.id }}"
            gh run download ${{ github.event.workflow_run.id }} --dir ./release-artifact --raw || echo "No artifacts found in workflow_run"
          else
            echo "Manual trigger: fetching latest successful build artifacts"
            LAST_RUN_ID=$(gh run list --workflow "Build macOS Installer ISO/DMG image" --branch main --status success --limit 1 --json databaseId -q '.[0].databaseId')
            if [ -n "$LAST_RUN_ID" ]; then
              echo "Latest successful build run: $LAST_RUN_ID"
              gh run download $LAST_RUN_ID --dir ./release-artifact --raw || echo "No artifacts found in latest build run"
            else
              echo "No previous successful build run found"
            fi
          fi

      - name: List files to be uploaded
        run: |
          echo "Files to be uploaded:"
          if [ -d ./release-artifact ] && [ "$(ls -A ./release-artifact)" ]; then
            find ./release-artifact -type f
          else
            ls -1 ./*.iso ./*.dmg.img 2>/dev/null || echo "No ISO/DMG files found in ./ or release-artifact"
          fi

      - name: Upload files to GitHub Release v1.0.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Only upload files if they exist
          if [ -d ./release-artifact ] && [ "$(ls -A ./release-artifact)" ]; then
            echo "Uploading files to existing release v1.0.0"
            gh release upload v1.0.0 ./release-artifact/* --clobber
          else
            echo "No files to upload"
          fi
