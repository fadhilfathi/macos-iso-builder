name: Publish Release v1.0.0

on:
  workflow_dispatch:  # can be triggered manually
  workflow_run:
    workflows:
      - "Build macOS Installer ISO/DMG image"
    types:
      - completed

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo â€” required for gh release
      - name: Checkout repository
        uses: actions/checkout@v5

      # Set GH_TOKEN for gh CLI
      - name: Set GH_TOKEN
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "GH_TOKEN set"

      # List ISO/DMG files
      - name: List files to be uploaded
        run: |
          echo "Searching for ISO/DMG files..."
          find . -maxdepth 2 -type f -name "*.iso" -o -name "*.dmg.img" || echo "No ISO/DMG files found"

      # Upload files to GitHub Release v1.0.0
      - name: Upload files to GitHub Release v1.0.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES=$(find . -maxdepth 2 -type f -name "*.iso" -o -name "*.dmg.img")
          if [ -z "$FILES" ]; then
            echo "No ISO/DMG files found, skipping release upload"
            exit 0
          fi

          # Create release if it doesn't exist
          gh release create v1.0.0 \
            --title "v1.0.0" \
            --notes "Automated macOS installer image release" \
            --latest || echo "Release already exists"

          # Upload each file
          for f in $FILES; do
            echo "Uploading $f..."
            gh release upload v1.0.0 "$f" --clobber
          done
