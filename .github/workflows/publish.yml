name: Publish Release v1.0.0

on:
  workflow_run:
    workflows:
      - "Build macOS Installer ISO/DMG image"
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo â€” required for gh release
      - name: Checkout repository
        uses: actions/checkout@v5

      # Set GH_TOKEN for gh CLI
      - name: Set GH_TOKEN
        run: echo "GH_TOKEN is set"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Download artifacts from workflow_run or latest successful build
      - name: Download latest build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./release-artifact

          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            echo "Downloading artifacts from workflow_run ID ${{ github.event.workflow_run.id }}"
            # Download all artifacts
            ARTIFACTS=$(gh run view ${{ github.event.workflow_run.id }} --json artifacts -q '.artifacts[].name')
            for a in $ARTIFACTS; do
              echo "Downloading artifact: $a"
              gh run download ${{ github.event.workflow_run.id }} --name "$a" --dir ./release-artifact || echo "Failed to download $a"
            done
          else
            echo "Manual trigger: fetching latest successful build artifacts"
            LAST_RUN_ID=$(gh run list --workflow "Build macOS Installer ISO/DMG image" --branch main --status success --limit 1 --json databaseId -q '.[0].databaseId')
            if [ -n "$LAST_RUN_ID" ]; then
              echo "Latest successful build run: $LAST_RUN_ID"
              ARTIFACTS=$(gh run view $LAST_RUN_ID --json artifacts -q '.artifacts[].name')
              for a in $ARTIFACTS; do
                echo "Downloading artifact: $a"
                gh run download $LAST_RUN_ID --name "$a" --dir ./release-artifact || echo "Failed to download $a"
              done
            else
              echo "No previous successful build run found"
            fi
          fi

      # List all downloaded files for debugging
      - name: List files to be uploaded
        run: |
          echo "Files to be uploaded:"
          find ./release-artifact -type f -name "*.iso" -o -name "*.dmg.img" || echo "No ISO/DMG files found"

      # Upload files to GitHub Release v1.0.0
      - name: Upload files to GitHub Release v1.0.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload all ISO/DMG files inside nested folders
          find ./release-artifact -type f -name "*.iso" -o -name "*.dmg.img" | while read f; do
            echo "Uploading $f to release v1.0.0"
            gh release upload v1.0.0 "$f" --clobber || echo "Failed to upload $f"
          done
